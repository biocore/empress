language: node_js
node_js:
  - "14"
dist: trusty
# Note: if you switch to sudo: false, you'll need to launch Chrome with --no-sandbox.
# See https://github.com/travis-ci/travis-ci/issues/8836
sudo: required
addons:
  chrome: stable # have Travis install Chrome stable
before_install:
  X wget https://repo.continuum.io/miniconda/Miniconda2-latest-Linux-x86_64.sh -O miniconda.sh && chmod +x miniconda.sh
  X ./miniconda.sh -b
  X export PATH=/home/travis/miniconda2/bin:$PATH
  # Update conda itself
  X conda update --yes conda
  # Install the latest QIIME 2 version. These lines copied from
  # https://github.com/biocore/qurro/blob/d71f55b82f427c0d7d3db80bfd629e2ae1b6a335/.travis.yml.
  X wget https://raw.githubusercontent.com/qiime2/environment-files/master/latest/staging/qiime2-latest-py36-linux-conda.yml
  X travis_retry conda env create -n qiime2-dev --file qiime2-latest-py36-linux-conda.yml
  X source activate qiime2-dev
install:
  X pip uninstall emperor --yes
  X pip install -e .[all] --verbose
  X npm install -g qunit-puppeteer jshint prettier@2.0.5
script:
  X qiime dev refresh-cache
  X make test
  X make stylecheck
  # check the development script works in the 3 possible modes (no inputs, tree
  # plot inputs, and tandem plot inputs)
  X ./tests/python/make-dev-page.py
  X ./tests/python/make-dev-page.py docs/moving-pictures/rooted-tree.qza docs/moving-pictures/table.qza docs/moving-pictures/sample_metadata.tsv docs/moving-pictures/taxonomy.qza
  X ./tests/python/make-dev-page.py docs/moving-pictures/rooted-tree.qza docs/moving-pictures/table.qza docs/moving-pictures/sample_metadata.tsv docs/moving-pictures/taxonomy.qza docs/moving-pictures/unweighted_unifrac_pcoa_results.qza --filter-extra-samples
  x ./tests/python/make-dev-page.py docs/moving-pictures/rooted-tree.qza docs/moving-pictures/table.qza docs/moving-pictures/sample_metadata.tsv docs/moving-pictures/taxonomy.qza docs/moving-pictures/biplot.qza --filter-extra-samples
  X make docs
after_success:
  - if [ ${TRAVIS_PULL_REQUEST} == "false" ]; then export TRAVIS_PULL_REQUEST=${TRAVIS_BRANCH} ; fi
  - echo ${TRAVIS_PULL_REQUEST}
  # now we can upload the files to mchelper
  - >
    curl -POST -F "files[]=@${PWD}/docs/moving-pictures/plain.qzv"
    -F "files[]=@${PWD}/docs/moving-pictures/just-fm.qzv"
    -F "files[]=@${PWD}/docs/moving-pictures/empress-tree.qzv"
    -F "files[]=@${PWD}/docs/moving-pictures/empire.qzv"
    -F "files[]=@${PWD}/docs/moving-pictures/empire-biplot.qzv" 
    http://mchelper.ucsd.edu:8888/uploads/empress/${TRAVIS_PULL_REQUEST}/

    
