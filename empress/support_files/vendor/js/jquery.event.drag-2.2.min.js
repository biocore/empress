!function(p){p.fn.drag=function(t,e,a){var n="string"==typeof t?t:"",r=p.isFunction(t)?t:p.isFunction(e)?e:null;return 0!==n.indexOf("drag")&&(n="drag"+n),a=(t==r?e:a)||{},r?this.bind(n,a,r):this.trigger(n)};var h=p.event,n=h.special,g=n.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:!1,drop:!0,click:!1},datakey:"dragdata",noBubble:!0,add:function(t){var a=p.data(this,g.datakey),n=t.data||{};a.related+=1,p.each(g.defaults,function(t,e){void 0!==n[t]&&(a[t]=n[t])})},remove:function(){p.data(this,g.datakey).related-=1},setup:function(){if(!p.data(this,g.datakey)){var t=p.extend({related:0},g.defaults);p.data(this,g.datakey,t),h.add(this,"touchstart mousedown",g.init,t),this.attachEvent&&this.attachEvent("ondragstart",g.dontstart)}},teardown:function(){(p.data(this,g.datakey)||{}).related||(p.removeData(this,g.datakey),h.remove(this,"touchstart mousedown",g.init),g.textselect(!0),this.detachEvent&&this.detachEvent("ondragstart",g.dontstart))},init:function(t){if(!g.touched){var e,a=t.data;if(!(0!=t.which&&0<a.which&&t.which!=a.which)&&!p(t.target).is(a.not)&&(!a.handle||p(t.target).closest(a.handle,t.currentTarget).length)&&(g.touched="touchstart"==t.type?this:null,a.propagates=1,a.mousedown=this,a.interactions=[g.interaction(this,a)],a.target=t.target,a.pageX=t.pageX,a.pageY=t.pageY,a.dragging=null,e=g.hijack(t,"draginit",a),a.propagates))return(e=g.flatten(e))&&e.length&&(a.interactions=[],p.each(e,function(){a.interactions.push(g.interaction(this,a))})),a.propagates=a.interactions.length,!1!==a.drop&&n.drop&&n.drop.handler(t,a),g.textselect(!1),g.touched?h.add(g.touched,"touchmove touchend",g.handler,a):h.add(document,"mousemove mouseup",g.handler,a),!(!g.touched||a.live)&&void 0}},interaction:function(t,e){var a=p(t)[e.relative?"position":"offset"]()||{top:0,left:0};return{drag:t,callback:new g.callback,droppable:[],offset:a}},handler:function(t){var e=t.data;switch(t.type){case!e.dragging&&"touchmove":t.preventDefault();case!e.dragging&&"mousemove":if(Math.pow(t.pageX-e.pageX,2)+Math.pow(t.pageY-e.pageY,2)<Math.pow(e.distance,2))break;t.target=e.target,g.hijack(t,"dragstart",e),e.propagates&&(e.dragging=!0);case"touchmove":t.preventDefault();case"mousemove":if(e.dragging){if(g.hijack(t,"drag",e),e.propagates){!1!==e.drop&&n.drop&&n.drop.handler(t,e);break}t.type="mouseup"}case"touchend":case"mouseup":default:g.touched?h.remove(g.touched,"touchmove touchend",g.handler):h.remove(document,"mousemove mouseup",g.handler),e.dragging&&(!1!==e.drop&&n.drop&&n.drop.handler(t,e),g.hijack(t,"dragend",e)),g.textselect(!0),!1===e.click&&e.dragging&&p.data(e.mousedown,"suppress.click",(new Date).getTime()+5),e.dragging=g.touched=!1}},hijack:function(a,n,r,t,e){if(r){var o,i,d,s={event:a.originalEvent,type:a.type},c=n.indexOf("drop")?"drag":"drop",l=t||0,u=isNaN(t)?r.interactions.length:t;a.type=n,a.originalEvent=null,r.results=[];do{if(i=r.interactions[l]){if("dragend"!==n&&i.cancelled)continue;d=g.properties(a,r,i),i.results=[],p(e||i[c]||r.droppable).each(function(t,e){if(d.target=e,!(a.isPropagationStopped=function(){return!1})===(o=e?h.dispatch.call(e,a,d):null)?("drag"==c&&(i.cancelled=!0,r.propagates-=1),"drop"==n&&(i[c][t]=null)):"dropinit"==n&&i.droppable.push(g.element(o)||e),"dragstart"==n&&(i.proxy=p(g.element(o)||i.drag)[0]),i.results.push(o),delete a.result,"dropinit"!==n)return o}),r.results[l]=g.flatten(i.results),"dropinit"==n&&(i.droppable=g.flatten(i.droppable)),"dragstart"!=n||i.cancelled||d.update()}}while(++l<u);return a.type=s.type,a.originalEvent=s.event,g.flatten(r.results)}},properties:function(t,e,a){var n=a.callback;return n.drag=a.drag,n.proxy=a.proxy||a.drag,n.startX=e.pageX,n.startY=e.pageY,n.deltaX=t.pageX-e.pageX,n.deltaY=t.pageY-e.pageY,n.originalX=a.offset.left,n.originalY=a.offset.top,n.offsetX=n.originalX+n.deltaX,n.offsetY=n.originalY+n.deltaY,n.drop=g.flatten((a.drop||[]).slice()),n.available=g.flatten((a.droppable||[]).slice()),n},element:function(t){if(t&&(t.jquery||1==t.nodeType))return t},flatten:function(t){return p.map(t,function(t){return t&&t.jquery?p.makeArray(t):t&&t.length?g.flatten(t):t})},textselect:function(t){p(document)[t?"unbind":"bind"]("selectstart",g.dontstart).css("MozUserSelect",t?"":"none"),document.unselectable=t?"off":"on"},dontstart:function(){return!1},callback:function(){}};g.callback.prototype={update:function(){n.drop&&this.available.length&&p.each(this.available,function(t){n.drop.locate(this,t)})}};var e=h.dispatch;h.dispatch=function(t){if(!(0<p.data(this,"suppress."+t.type)-(new Date).getTime()))return e.apply(this,arguments);p.removeData(this,"suppress."+t.type)};var r=h.fixHooks.touchstart=h.fixHooks.touchmove=h.fixHooks.touchend=h.fixHooks.touchcancel={props:"clientX clientY pageX pageY screenX screenY".split(" "),filter:function(a,t){if(t){var n=t.touches&&t.touches[0]||t.changedTouches&&t.changedTouches[0]||null;n&&p.each(r.props,function(t,e){a[e]=n[e]})}return a}};n.draginit=n.dragstart=n.dragend=g}(jQuery);